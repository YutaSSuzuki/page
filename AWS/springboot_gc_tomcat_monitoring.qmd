---
title: "Spring Boot GCãƒ»Tomcatã‚¹ãƒ¬ãƒƒãƒ‰æ•°ç›£è¦–ï¼ˆStatsD + CloudWatchï¼‰"
format: html
editor: visual
---

## âœ… æ§‹æˆæ¦‚è¦

```
Spring Boot (Micrometer StatsD)  
   â†“ UDP  
CloudWatch Agent (StatsD Listener)  
   â†“  
Amazon CloudWatchï¼ˆãƒ¡ãƒˆãƒªã‚¯ã‚¹ & ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼‰
```

---

## ğŸ§© äº‹å‰è¦ä»¶

- Amazon EC2 ä¸Šã« Spring Boot ã‚¢ãƒ—ãƒªã‚’æ§‹ç¯‰æ¸ˆã¿
- CloudWatch Agent ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
- EC2 ã« IAM ãƒ­ãƒ¼ãƒ« `AmazonCloudWatchAgentServerPolicy` ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹ã“ã¨

å¿…è¦ãªã‚³ãƒãƒ³ãƒ‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
``` bash
#java
sudo yum install -y java-1.8.0-openjdk
#unzip
sudo yum install -y unzip
#ss
sudo yum install -y iproute

#cloudwatch agent
sudo dnf install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm
sudo systemctl enable amazon-ssm-agent

```


---

## ğŸª› 1. Spring Boot ã‚¢ãƒ—ãƒªã« Micrometer + StatsD ã‚’å°å…¥

### pom.xml ã«ä¾å­˜è¿½åŠ 

````xml
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
<dependency>
  <groupId>io.micrometer</groupId>
  <artifactId>micrometer-registry-statsd</artifactId>
</dependency>
````

### application.properties ã®è¨­å®š

````properties
management.metrics.export.statsd.enabled=true
management.metrics.export.statsd.host=localhost
management.metrics.export.statsd.port=8125
management.metrics.enable.jvm=true
management.metrics.enable.tomcat=true
logging.level.io.micrometer.statsd=INFO
````

---

## ğŸ§  2. è‡ªå‹•åé›†ã•ã‚Œã‚‹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ä¾‹

### GC é–¢é€£
- `jvm.gc.pause`
- `jvm.gc.max.data.size`
- `jvm.memory.used`
- `jvm.memory.max`

### Tomcat ã‚¹ãƒ¬ãƒƒãƒ‰é–¢é€£
- `tomcat.threads.config.max`
- `tomcat.threads.current`
- `tomcat.threads.busy`

---

## ğŸ“¦ 3. CloudWatch Agent ã®è¨­å®š

### `/opt/aws/amazon-cloudwatch-agent/bin/config.json` è¨­å®šä¾‹

````json
{
  "metrics": {
    "metrics_collected": {
      "statsd": {
        "service_address": ":8125",
        "metrics_collection_interval": 10,
        "metrics_aggregation_interval": 60
      }
    }
  }
}
````

### è¨­å®šé©ç”¨ã‚³ãƒãƒ³ãƒ‰

````bash
sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
  -a fetch-config \
  -m ec2 \
  -c file:/opt/aws/amazon-cloudwatch-agent/bin/config.json \
  -s
````

---

## ğŸ” 4. CloudWatch ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç¢ºèª

CloudWatch ã‚³ãƒ³ã‚½ãƒ¼ãƒ« â†’ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ â†’ åå‰ç©ºé–“ï¼š`StatsD`  
å¯¾è±¡ãƒ¡ãƒˆãƒªã‚¯ã‚¹ä¾‹ï¼š

| ã‚¿ã‚¤ãƒˆãƒ« | ãƒ¡ãƒˆãƒªã‚¯ã‚¹å |
|----------|--------------|
| GC Pause | `jvm.gc.pause` |
| Max Data Size | `jvm.gc.max.data.size` |
| Current Threads | `tomcat.threads.current` |
| Busy Threads | `tomcat.threads.busy` |

---

## ğŸ“Š 5. CloudWatch Dashboards ã§å¯è¦–åŒ–ï¼ˆä¾‹ï¼‰

```
metric1 / 1000  # GC Pauseã‚’ç§’ã«å¤‰æ›
```

---

## âœ… å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [x] Spring Boot å´ã« Micrometer StatsD å°å…¥æ¸ˆã¿  
- [x] GCãƒ»Tomcat ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ï¼ˆ`nc -u -l 8125` ãªã©ã§ç¢ºèªï¼‰  
- [x] CloudWatch Agent ãŒèµ·å‹•ãƒ»8125ãƒªãƒƒã‚¹ãƒ³ä¸­  
- [x] CloudWatch ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§å¯è¦–åŒ–ã§ããŸ